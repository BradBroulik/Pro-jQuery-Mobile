<!DOCTYPE html> 
<html> 
	<head> 
	<meta charset="utf-8">
	<title>Maps</title> 
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="http://code.jquery.com/mobile/1.2.0-rc.1/jquery.mobile-1.2.0-rc.1.min.css" />
	<style>
		/* TODO: use dynamic Geo location
		$.urlParam = function(name) { 
			var results = RegExp('[\?&]' + name + '=([^&#]*)').exec(top.window.location.href);  
			return (results !== null) ? results[1] : 0;  
		}*/
		
		#show-more .ui-li-heading { text-align:center; }
		#show-more .ui-icon { visibility:hidden; }
		
		.segmented-control { text-align:center; }
		.segmented-control .ui-controlgroup { display:inline; margin:.2em 0px; }
		#map-page { width:100%; height:100%; }
		.ui-gmap-canvas { width:100%; height:100%; }
		#map-canvas { width:100%; height:100%; margin-top:-30px; padding:0px!important; }
		#gmap-marker-link { color:#00a0df; text-decoration:none; }
		.ui-gmap-infobox { display:none; }
		
		.ui-li-aside { width:55px; }
		.wrap { white-space:normal; }
	</style>	
	<script src="http://code.jquery.com/jquery-1.8.1.min.js"></script>
	<script src="http://code.jquery.com/mobile/1.2.0-rc.1/jquery.mobile-1.2.0-rc.1.min.js"></script>
</head> 
<body>
<div data-role="page" id="map-page">
	<div data-role="header" data-position="fixed">
		<div class="segmented-control ui-bar-d">
	 	<fieldset data-role="controlgroup" data-type="horizontal" data-mini="true">
  			<input type="radio" name="switch" id="list-switch" checked="true"/>
			<label for="list-switch">List</label>
         	<input type="radio" name="switch" id="map-switch" />
         	<label for="map-switch">Map</label>
	    </fieldset>
		</div>
	</div>
	<div data-role="content" class="ui-content-list">	
        <div id="list-canvas">
            <ul id="list-results" data-role="listview">
            	<li data-marker-info="44.811805,-93.176352">
				  <div style="display:none;">
				    <div class="ui-gmap-marker-info">
				  	  <h1><a id="gmap-marker-link" href="#">MinuteClinic-CVS</a></h1>
				  	  <p>4241 Johnny Cake Rd</p>
				  	</div>
				  </div>
            	  <a href="#">
            	  	<h1 class="ui-gmap-marker-title wrap">MinuteClinic-CVS</h1>
            	  	<div class="ui-li-aside">
            	  		<p>0.71 miles</p>
            	  	</div>
            	  </a>
            	</li>
            	<li data-marker-info="44.788673,-93.205671">
				  <div style="display:none;">
				    <div class="ui-gmap-marker-info">
				  	  <h1><a id="gmap-marker-link" href="#">North Memorial Urgent Care - Eagan</a></h1>
				  	  <p>1970 Rahncliff Ct</p>
				  	</div>
				  </div>
            	  <a href="#">
            	  	<h1 class="ui-gmap-marker-title wrap">North Memorial Urgent Care - Eagan</h1>
            	  	<div class="ui-li-aside">
            	  		<p>0.71 miles</p>
            	  	</div>
            	  </a>
            	</li>
            	<li data-marker-info="44.750453,-93.204766">
				  <div style="display:none;">
				    <div class="ui-gmap-marker-info">
				  	  <h1><a id="gmap-marker-link" href="#">MinuteClinic-Apple Valley/Rosemount</a></h1>
				  	  <p>15115 Dove Trl</p>
				  	</div>
				  </div>
            	  <a href="details.html?locationId=4719">
            	  	<h1 class="ui-gmap-marker-title wrap">MinuteClinic-Apple Valley/Rosemount</h1>
            	  	<div class="ui-li-aside">
            	  		<p>4.15 miles</p>
            	  	</div>
            	  </a>
            	</li>
            	<li data-marker-info="44.736285,-93.207487">
				  <div style="display:none;">
				    <div class="ui-gmap-marker-info">
				  	  <h1><a id="gmap-marker-link" href="#">Apple Valley Medical Clinic - Urgent Care</a></h1>
				  	  <p>14655 Galaxie Ave</p>
				  	</div>
				  </div>
            	  <a href="#">
            	  	<h1 class="ui-gmap-marker-title wrap">Apple Valley Medical Clinic - Urgent Care</h1>
            	  	<div class="ui-li-aside">
            	  		<p>5.09 miles</p>
            	  	</div>
            	  </a>
            	</li>
            	<li data-marker-info="44.723595,-93.176812">
				  <div style="display:none;">
				    <div class="ui-gmap-marker-info">
				  	  <h1><a id="gmap-marker-link" href="#">Target Clinics - Apple Valley South</a></h1>
				  	  <p>15560 Pilot Knob Rd</p>
				  	</div>
				  </div>
            	  <a href="#">
            	  	<h1 class="ui-gmap-marker-title wrap">Target Clinics - Apple Valley South</h1>
            	  	<div class="ui-li-aside">
            	  		<p>5.58 miles</p>
            	  	</div>
            	  </a>
            	</li>
				<li id="show-more"><a href=""><h1>Show more</h1></a></li>								
			</ul>
		</div>
	</div>
	<div data-role="content" id="map-canvas" data-initial-view="44.80,-93.16,10" style="display:none;"></div>
<script type="application/javascript">
$( "#map-page" ).on( "pageinit", function(){
	var $mapSwitch = $( "#map-switch" ),
	    $listSwitch = $( "#list-switch" ),
		$map = $("#map-canvas"),
        $list = $("#list-canvas");
		
    $mapSwitch.on( "click", function(e){
       	$map.show();
       	$map.gmap();
       	$list.hide();
    });
	
    $listSwitch.on( "click", function(e){
       	$list.show();
		$map.hide();
    });
	
    var initLocation = function() {
    	var location = {}; location.coords = location.coords || {}; location.coords.latitude = location.coords.latitude || {}; location.coords.longitude = location.coords.longitude || {};
    	return location;
    };
		
    $("#show-more a").on( 'click', function(e){
    	var location = initLocation();
    	location.coords.latitude = $.urlParam("lat");
    	location.coords.longitude = $.urlParam("lon");
    	JQM.geo.startIndex = $("#list-results li").size() -1; // exclude show more list item
    	JQM.geo.showMore(location);
    	e.preventDefault();
    });	

$.urlParam = function(name) { 
	var results = RegExp('[\?&]' + name + '=([^&#]*)').exec(top.window.location.href);  
	return (results !== null) ? results[1] : 0;  
}

/**
 * Geolocation configuration
 */
var JQM = JQM || {};
JQM.geo = {
	location: "",
	zip: "",
	startIndex: "",
	
	/*
	 * Call JQM.geo.init() to initialize a geoloation-based search.
	 */
    init: function() {
    	var self = this;
    	if ( navigator.geolocation ) {
    		console.log("navigator.geolocation...");
			// Find the users current position.  Cache the location for 5 minutes (500000), timeout after 10 seconds (timeout: 10000)
			navigator.geolocation.getCurrentPosition(self.success, self.fail, {maximumAge:500000, enableHighAccuracy:true, timeout:10000 });
    	}
    },
    
    success: function(latlng) {
    	JQM.geo.location = latlng;
    	window.location.href=JQM.geo.getSearchUrl();
    },
    
    fail: function(error) {
    	console.log("navigator.geolocation FAIL " + error);
		// When geolocation is not available, prompte the user to enter their zipcode/city,state to get started.
    	window.location.href="search.html";
    },

    showMore: function(latlng) {
    	$.mobile.showPageLoadingMsg();
    	JQM.geo.location = latlng;

		$.ajax({
		  	url: "showMore.html?lat="+JQM.geo.location.coords.latitude+"&lon="+JQM.geo.location.coords.longitude+"&zip="+JQM.geo.zip+"&startIndex="+JQM.geo.startIndex,
		  	success: function( response ) {
		  		var $listResults = $( "#list-results" );
				$listResults.find( "#show-more" ).before(response);
				$listResults.listview( "refresh" );
				$.mobile.hidePageLoadingMsg();
		  	},
			timeout: 12000,  // Timeout after 12 seconds
			error: function(jqXHR, textStatus, errorThrown) {
				console.log("Error, textStatus: " + textStatus + " errorThrown: "+ errorThrown);
				$.mobile.hidePageLoadingMsg();
			}
		});

    },
    
    getSearchUrl: function() {
    	return "search.html?lat="+JQM.geo.location.coords.latitude+"&lon="+JQM.geo.location.coords.longitude+"&zip="+JQM.geo.zip;
    }
};	
});
</script>
<!-- Load map assets at bottom for performance -->
<script src="jquery.gmap.js"></script>
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
<script type="text/javascript" src="http://google-maps-utility-library-v3.googlecode.com/svn/tags/infobox/1.0/src/infobox_packed.js"></script>			

</div>
</body>
</html>

